<nav style="display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; background-color: #343a40; color: white; margin-bottom: 20px;">
    <div>
        <strong style="font-size: 1.2rem;">Black@ E-Commerce</strong>
    </div>
    <div style="display: flex; align-items: center; gap: 20px;">
        <span id="user-display" style="font-style: italic; color: #ffc107;">Cargando usuario...</span>
        <a href="/api/sessions/logout" style="text-decoration: none; color: white; background-color: #dc3545; padding: 6px 12px; border-radius: 4px; font-size: 0.9rem;">Cerrar Sesi贸n</a>
    </div>
</nav>

<h1>Lista de Productos</h1>

<div class="products-grid">
    {{#each products}}
    <div class="product-card">
        {{#if this.thumbnails.[0]}}
            <img src="{{this.thumbnails.[0]}}" alt="{{this.title}}" class="product-image">
        {{else}}
            <img src="/images/default.jpg" alt="Imagen por defecto" class="product-image">
        {{/if}}
        
        <h2>{{this.title}}</h2> 
        <p>{{this.description}}</p>
        <p>Precio: ${{this.price}}</p>
        <p>Categor铆a: {{this.category}}</p>
        
        <div class="actions">
            <button onclick="viewProductDetail('{{this._id}}')" class="view-detail">Ver detalle</button> 
            <button onclick="addToCart('{{this._id}}')" class="add-to-cart">Agregar al carrito</button>
        </div>
    </div>
    {{/each}}
</div>

<div style="position: fixed; top: 70px; right: 10px; cursor: pointer; font-size: 25px; padding: 10px; background-color: #edf2ee; border-radius: 40%; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); text-align: center; z-index: 999;" 
     onclick="toggleCartModal()">
     <span id="cart-count" style="font-size: 18px; color: #007BFF;">0</span>
</div>

<div id="cart-modal" style="display: none; position: fixed; top: 120px; right: 20px; background: white; border: 1px solid #ccc; padding: 20px; width: 320px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); z-index: 1000;">
    <h3>Mi Carrito</h3>
    <div id="cart-products" style="max-height: 300px; overflow-y: auto; margin-bottom: 10px;"></div>
    <div style="display: flex; gap: 10px;">
        <button onclick="window.location.href='/cart'">Ver todo</button>
        <button onclick="toggleCartModal()">Cerrar</button>
    </div>
</div>

<form id="filterForm" style="margin: 20px 0;">
    <label for="category">Categor铆a:</label>
    <select id="category">
        <option value="">Todas</option>
        <option value="Electr贸nica">Electr贸nica</option>
        <option value="Audio">Audio</option>
        <option value="Hogar">Hogar</option>
    </select>

    <label for="sort">Precio:</label>
    <select id="sort">
        <option value="">Sin orden</option>
        <option value="asc">Menor a Mayor</option>
        <option value="desc">Mayor a Menor</option>
    </select>

    <button type="submit">Filtrar</button>
</form>

<div class="pagination">
    {{#if hasPrevPage}}
    <a href="/products?page={{prevPage}}" class="page-link">Anterior</a>
    {{/if}}
    <span>P谩gina {{currentPage}} de {{totalPages}}</span>
    {{#if hasNextPage}}
    <a href="/products?page={{nextPage}}" class="page-link">Siguiente</a>
    {{/if}}
</div>

<script>
    let cartId = null;

    async function initSession() {
        try {
            const response = await fetch('/api/sessions/current');
            if (response.ok) {
                const data = await response.json();
                
                document.getElementById("user-display").textContent = `Usuario: ${data.payload.email}`;
                
                cartId = data.payload.cart._id || data.payload.cart; 
                console.log("Sesi贸n activa. Carrito ID:", cartId);
                updateCartBadge();
            } else {
               
                window.location.replace('/login');
            }
        } catch (error) {
            console.error("Error de sesi贸n:", error);
        }
    }

    function viewProductDetail(productId) {
        window.location.href = `/products/${productId}`; 
    }

    async function addToCart(productId) {
        if (!cartId) return alert("Debes iniciar sesi贸n");

        try {
            const response = await fetch(`/api/carts/${cartId}/products/${productId}`, { method: "POST" });
            if (response.ok) {
                updateCartBadge();
                alert("Agregado al carrito");
            }
        } catch (error) {
            console.error("Error al agregar:", error);
        }
    }

    async function updateCartBadge() {
        if (!cartId) return;
        try {
            const response = await fetch(`/api/carts/${cartId}`);
            if (response.ok) {
                const data = await response.json();
                const products = data.products || [];
                document.getElementById("cart-count").textContent = products.length;
                renderCartModal(products);
            }
        } catch (error) {
            console.error(error);
        }
    }

    function renderCartModal(products) {
        const container = document.getElementById("cart-products");
        container.innerHTML = "";
        if (products.length === 0) {
            container.innerHTML = "<p>Vac铆o</p>";
            return;
        }
        products.forEach(item => {
            const div = document.createElement("div");
            div.style.borderBottom = "1px solid #eee";
            div.style.padding = "5px 0";
            div.innerHTML = `<p style="margin:0; font-size: 0.9rem;">${item.product.title} (x${item.quantity})</p>`;
            container.appendChild(div);
        });
    }

    function toggleCartModal() {
        const modal = document.getElementById("cart-modal");
        modal.style.display = modal.style.display === "none" ? "block" : "none";
        if (modal.style.display === "block") updateCartBadge();
    }

    document.getElementById("filterForm").addEventListener("submit", function(event) {
        event.preventDefault();
        const category = document.getElementById("category").value;
        const sort = document.getElementById("sort").value;
        let queryParams = [];
        if (category) queryParams.push(`category=${category}`);
        if (sort) queryParams.push(`sort=${sort}`);
        window.location.href = `/products${queryParams.length ? '?' + queryParams.join("&") : ""}`;
    });

    initSession();
</script>